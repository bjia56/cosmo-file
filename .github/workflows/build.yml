name: Build and Test

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:
  workflow_call:

env:
  cosmocc_version: '4.0.2'

jobs:
  build-binary:
    name: Build file.com
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup cosmocc
        uses: bjia56/setup-cosmocc@v0.0.4
        with:
          version: ${{ env.cosmocc_version }}

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y autoconf automake libtool qemu-user-static zip

      - name: Build file.com
        run: ./scripts/build_file_com.sh

      - name: Upload binary artifact
        uses: actions/upload-artifact@v4
        with:
          name: file-binary
          path: src/cosmo_file/data/file.com
          if-no-files-found: error

      - name: Upload LICENSE artifact
        uses: actions/upload-artifact@v4
        with:
          name: file-license
          path: src/cosmo_file/data/COPYING
          if-no-files-found: error

  build-wheels:
    name: Build wheels
    needs: build-binary
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download binary artifact
        uses: actions/download-artifact@v4
        with:
          name: file-binary
          path: src/cosmo_file/data/

      - name: Make binary executable
        run: chmod +x src/cosmo_file/data/file.com

      - name: Download LICENSE artifact
        uses: actions/download-artifact@v4
        with:
          name: file-license
          path: src/cosmo_file/data/

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install build tools
        run: pip install build wheel

      - name: Download pledge and assimilate
        run: |
          wget https://cosmo.zip/pub/cosmos/v/4.0.2/bin/pledge -O /tmp/pledge
          chmod +x /tmp/pledge

          wget https://cosmo.zip/pub/cosmos/v/4.0.2/bin/assimilate -O /tmp/assimilate
          chmod +x /tmp/assimilate

      - name: Build wheels for all platforms
        run: |
          # Build a wheel to extract version
          python -m build --wheel
          WHEEL_NAME=$(ls dist/*.whl | head -n 1 | xargs basename)
          VERSION=$(echo $WHEEL_NAME | grep -oP '\d+\.\d+\.\d+')
          rm -f dist/*.whl

          # Build a separate wheel for each platform
          mkdir -p dist/wheels
          for platform in win_amd64 macosx_10_9_x86_64 macosx_11_0_arm64; do
            echo "$platform" > src/cosmo_file/data/platform
            python -m build --wheel
            WHEEL=$(ls dist/*.whl | head -n 1)
            mv "$WHEEL" "dist/wheels/cosmo_file-${VERSION}-py3-none-${platform}.whl"
          done

          # Move APE binary out of workspace, we don't want it in the Linux wheels
          mv src/cosmo_file/data/file.com /tmp/file.com

          # Move pledge into data directory for Linux wheels
          mv /tmp/pledge src/cosmo_file/data/pledge

          # Build x86_64 Linux wheel
          /tmp/assimilate -e -x -o src/cosmo_file/data/file.elf /tmp/file.com
          echo "manylinux_2_17_x86_64" > src/cosmo_file/data/platform
          python -m build --wheel
          WHEEL=$(ls dist/*.whl | head -n 1)
          mv "$WHEEL" "dist/wheels/cosmo_file-${VERSION}-py3-none-manylinux_2_17_x86_64.whl"

          # Build aarch64 Linux wheel
          /tmp/assimilate -e -a -o src/cosmo_file/data/file.elf /tmp/file.com
          echo "manylinux_2_17_aarch64" > src/cosmo_file/data/platform
          python -m build --wheel
          WHEEL=$(ls dist/*.whl | head -n 1)
          mv "$WHEEL" "dist/wheels/cosmo_file-${VERSION}-py3-none-manylinux_2_17_aarch64.whl"

          # List generated wheels
          ls -lh dist/wheels/

      - name: Upload wheel artifacts
        uses: actions/upload-artifact@v4
        with:
          name: wheels
          path: dist/wheels/*.whl
