name: Build and Test

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:
  workflow_call:

env:
  cosmocc_version: '4.0.2'

jobs:
  build-binary:
    name: Build file.com
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup cosmocc
        uses: bjia56/setup-cosmocc@v0.0.4
        with:
          version: ${{ env.cosmocc_version }}

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y autoconf automake libtool qemu-user-static zip

      - name: Build file.com
        run: ./scripts/build_file_com.sh

      - name: Upload binary artifact
        uses: actions/upload-artifact@v4
        with:
          name: file-binary
          path: src/cosmo_file/data/file.com
          if-no-files-found: error

      - name: Upload LICENSE artifact
        uses: actions/upload-artifact@v4
        with:
          name: file-license
          path: src/cosmo_file/data/COPYING
          if-no-files-found: error

  build-wheels:
    name: Build wheels
    needs: build-binary
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download binary artifact
        uses: actions/download-artifact@v4
        with:
          name: file-binary
          path: src/cosmo_file/data/

      - name: Make binary executable
        run: chmod +x src/cosmo_file/data/file.com

      - name: Download LICENSE artifact
        uses: actions/download-artifact@v4
        with:
          name: file-license
          path: src/cosmo_file/data/

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install build tools
        run: pip install build wheel

      - name: Build wheels for all platforms
        run: |
          # Build base wheel
          python -m build --wheel

          # Create output directory
          mkdir -p dist/wheels

          # Get the base wheel name
          BASE_WHEEL=$(ls dist/*.whl)

          # Use wheel tool to properly retag for each platform
          for platform in win_amd64 macosx_10_9_x86_64 macosx_11_0_arm64 manylinux_2_17_x86_64 manylinux_2_17_aarch64; do
            wheel tags --platform-tag=${platform} --remove ${BASE_WHEEL}
            mv ${BASE_WHEEL%.whl}-${platform}.whl dist/wheels/
            # Rebuild base wheel for next iteration
            python -m build --wheel
            BASE_WHEEL=$(ls dist/*.whl)
          done

          # Clean up leftover base wheel
          rm -f dist/*.whl

          # List generated wheels
          ls -lh dist/wheels/

      - name: Upload wheel artifacts
        uses: actions/upload-artifact@v4
        with:
          name: wheels
          path: dist/wheels/*.whl
